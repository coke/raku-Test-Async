<!doctype html>
<html lang="en">
    <head>
        <title></title>
        <meta charset="UTF-8" />
        <style>
        kbd { font-family: "Droid Sans Mono", "Luxi Mono", "Inconsolata", monospace }
        samp { font-family: "Terminus", "Courier", "Lucida Console", monospace }
        u { text-decoration: none }
        .nested {
            margin-left: 3em;
        }
        aside, u { opacity: 0.7 }
        a[id^="fn-"]:target { background: #ff0 }
        </style>
        <link rel="stylesheet" href="//design.perl6.org/perl.css">
        
        
    </head>
    <body class="pod">
    <div id="___top"></div>
    
    
    
    <nav class="indexgroup">
<table id="TOC">
<caption><h2 id="TOC_Title">Table of Contents</h2></caption>
<tr class="toc-level-1"><td class="toc-number">1</td><td class="toc-text"><a href="#Test::Async_COOK_BOOK"><code class="pod-code-inline">Test::Async</code> COOK BOOK</a></td></tr>
  <tr class="toc-level-2"><td class="toc-number">1.1</td><td class="toc-text"><a href="#Tip_1._Testing_A_Multithreaded_Application">Tip 1. Testing A Multithreaded Application</a></td></tr>
                                 <tr class="toc-level-1"><td class="toc-number">2</td><td class="toc-text"><a href="#SEE_ALSO">SEE ALSO</a></td></tr>
   
</table>
</nav>

    <div class="pod-body">
    <h1 id="Test::Async_COOK_BOOK"><a class="u" href="#___top" title="go to top of document"><code>Test::Async</code> COOK BOOK</a></h1>
<p>Non-systematic collection of tips.</p>
<h2 id="Tip_1._Testing_A_Multithreaded_Application"><a class="u" href="#___top" title="go to top of document">Tip 1. Testing A Multithreaded Application</a></h2>
<p>One of the biggest reasons pushed me to implement <code>Test::Async</code> was a need to test event flow in <code>Vikna</code> toolkit. The problem with the standard <code>Test</code> framework was the need to invoke test tool from inside a separate thread or even threads causing havoc to the test output when <code>subtest</code>s are used. Similar problem could arise for any heavily threaded application where it is not always easy to get hold of the internal states without having direct access to them directly from a thread. Sure, it is technically possible to implement a communication channel which could be used to pass data into the test suit main thread, etc., etc., etc.</p>
<p>Nah, that&#39;s not how we do it! How about:</p>
<pre class="pod-block-code">my $test-app = MyTestApp.new;
subtest &quot;Threaded testing&quot; =&gt; {
    my $suite = test-suite;
    $test-app.set-test-suite: $suite;
    $test-app.test-something-threaded;
}</pre>
<p>and then somewhere in the <code>MyTestApp</code> class implementation, which is presumably inherits from the base application class and overrides some of its method for testing, we simply do something like:</p>
<pre class="pod-block-code">method foo($param) {
    $.test-suite.ok: self.is-param-valid($param), &quot;method foo got correct parameter&quot;;
    nextsame
}</pre>
<p><code>test-suite</code> attribute is the suite object implementing our subtest, which has been set with <code>set-test-suite</code> method.</p>
<p>Does it look a bit over-verbose? Ok, there is another way. Our test class could start new threads using core method <code>start</code> instead of the standard Raku keyword. Here is what it might look like:</p>
<pre class="pod-block-code">my $test-app = MyTestApp.new(:test-suite(test-suite));
subtest &quot;Threaded testing&quot; =&gt; {
    $test-app.test-something-threaded;
}</pre>
<p>The code in the <code>MyTestApp</code> class can now look like this:</p>
<pre class="pod-block-code">method new-task(&amp;code) {
    ...; # Whatever else should be done to start a task
    $.test-suite.start: &amp;code
}
method test-something-threaded {
    self.new-task: { self.testing-task }
}</pre>
<p>Though it now looks even more verbose than the previous example, we should remember that some kind of boilerplate code would be needed anyway and our first example still have it around. It&#39;s just nor relevant and thus not included here.</p>
<p>Back to the matter now. Eventually, this is what our <code>foo</code> method would look like now:</p>
<pre class="pod-block-code">use Test::Async;
...
method foo($param) {
    ok self.is-param-valid($param), &quot;method foo got correct parameter&quot;;
    nextsame
}</pre>
<h1 id="SEE_ALSO"><a class="u" href="#___top" title="go to top of document">SEE ALSO</a></h1>
<p><a href="https://github.com/vrurg/raku-Test-Async/blob/v0.0.1/docs/md/Test/Async.md"><code>Test::Async</code></a>, <a href="https://github.com/vrurg/raku-Test-Async/blob/v0.0.1/docs/md/Test/Async/Manual.md"><code>Test::Async::Manual</code></a></p>

    </div>
    
    
    </body>
</html>

